rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ====================================================================
    // 设备集合规则
    // ====================================================================
    match /devices/{deviceId} {
      // 临时放宽：所有已认证用户可读（用于调试）
      // TODO: 调试完成后恢复严格规则
      allow read: if request.auth != null;

      // 创建权限：已登录用户可以创建设备，且 ownerId 必须是自己
      allow create: if request.auth != null &&
                       request.resource.data.ownerId == request.auth.uid;

      // 更新权限：只能更新自己的设备
      allow update: if request.auth != null &&
                       resource.data.ownerId == request.auth.uid;

      // 删除权限：只能删除自己的设备
      allow delete: if request.auth != null &&
                       resource.data.ownerId == request.auth.uid;
    }

    // ====================================================================
    // 用户集合规则
    // ====================================================================
    match /users/{userId} {
      // 所有已登录用户可以读取（用于搜索和显示头像）
      allow read: if request.auth != null;

      // 只能创建/更新自己的用户信息
      allow create, update: if request.auth != null &&
                               request.auth.uid == userId;

      // 不允许删除
      allow delete: if false;
    }

    // ====================================================================
    // 位置共享集合规则
    // ====================================================================
    match /location_shares/{shareId} {
      // 读取: 分享者或接收者
      allow read: if request.auth != null && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid ||
        resource.data.toEmail == request.auth.token.email
      );

      // 创建: fromUid 必须是自己
      allow create: if request.auth != null &&
                       request.resource.data.fromUid == request.auth.uid;

      // 更新: 分享者或接收者
      allow update: if request.auth != null && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid ||
        resource.data.toEmail == request.auth.token.email
      );

      // 删除: 只有分享者
      allow delete: if request.auth != null &&
                       resource.data.fromUid == request.auth.uid;
    }

    // ====================================================================
    // 位置请求集合规则（支持多种请求类型）
    // ====================================================================
    match /locationRequests/{requestId} {
      // 创建权限：已认证用户，requesterUid 必须是自己
      allow create: if request.auth != null &&
                       request.resource.data.requesterUid == request.auth.uid &&
                       isValidRequestType(request.resource.data.type);

      // 读取权限：仅请求者或目标用户可以读取
      allow read: if request.auth != null && (
        resource.data.requesterUid == request.auth.uid ||
        resource.data.targetUid == request.auth.uid
      );

      // 更新权限：仅 Cloud Function 可以更新（通过 Admin SDK）
      allow update: if false;

      // 删除权限：请求者可以删除自己发起的请求
      allow delete: if request.auth != null &&
                       resource.data.requesterUid == request.auth.uid;
    }

    // ====================================================================
    // 辅助函数
    // ====================================================================

    // 验证请求类型是否有效
    function isValidRequestType(type) {
      return type in [
        'single',           // 单次位置请求
        'continuous',       // 开始连续追踪
        'stop_continuous',  // 停止连续追踪
        'play_sound',       // 播放查找提示音
        'stop_sound',       // 停止播放提示音
        'enable_lost_mode', // 启用丢失模式
        'disable_lost_mode' // 关闭丢失模式
      ];
    }

    // ====================================================================
    // 默认拒绝所有其他集合的访问
    // ====================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
