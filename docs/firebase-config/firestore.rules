rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ====================================================================
    // 设备集合规则
    // ====================================================================
    match /devices/{deviceId} {

      // 【开发/测试模式】- 允许所有读写操作
      // ⚠️ 警告：这仅适用于开发和测试环境！
      // 生产环境请使用下面注释的认证规则
      allow read, write: if true;

      // 【生产环境推荐规则】- 需要用户认证
      // 取消下面的注释并删除上面的 "allow read, write: if true;"
      /*
      // 1. 读取权限：已登录用户可以读取自己的设备
      allow read: if request.auth != null &&
                     resource.data.ownerId == request.auth.uid;

      // 2. 创建权限：已登录用户可以创建设备，且ownerId必须是自己
      allow create: if request.auth != null &&
                       request.resource.data.ownerId == request.auth.uid;

      // 3. 更新权限：只能更新自己的设备
      allow update: if request.auth != null &&
                       resource.data.ownerId == request.auth.uid;

      // 4. 删除权限：只能删除自己的设备
      allow delete: if request.auth != null &&
                       resource.data.ownerId == request.auth.uid;
      */
    }

    // ====================================================================
    // 联系人集合规则（如果需要）
    // ====================================================================
    match /contacts/{contactId} {
      allow read, write: if true;

      // 生产环境推荐规则
      /*
      allow read: if request.auth != null &&
                     resource.data.ownerId == request.auth.uid;
      allow write: if request.auth != null &&
                      request.resource.data.ownerId == request.auth.uid;
      */
    }

        // ====================================================================
    // 用户集合规则
    // ====================================================================
    match /users/{userId} {
      // 所有已登录用户可以读取(用于搜索)
      allow read: if request.auth != null;

      // 只能创建/更新自己的用户信息
      allow create, update: if request.auth != null &&
                               request.auth.uid == userId;

      // 不允许删除
      allow delete: if false;
    }

    // ====================================================================
    // 位置共享集合规则
    // ====================================================================
    match /location_shares/{shareId} {
      // 读取:分享者或接收者
      allow read: if request.auth != null && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid ||
        resource.data.toEmail == request.auth.token.email
      );

      // 创建:fromUid 必须是自己
      allow create: if request.auth != null &&
                       request.resource.data.fromUid == request.auth.uid;

      // 更新:分享者或接收者
      allow update: if request.auth != null && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid ||
        resource.data.toEmail == request.auth.token.email
      );

      // 删除:只有分享者
      allow delete: if request.auth != null &&
                       resource.data.fromUid == request.auth.uid;
    }

    // ====================================================================
    // 位置请求集合规则（按需唤醒功能）
    // ====================================================================
    match /locationRequests/{requestId} {
      // 创建权限：仅允许已认证用户创建，且 requesterUid 必须是自己
      allow create: if request.auth != null &&
                       request.resource.data.requesterUid == request.auth.uid;

      // 读取权限：仅请求者或目标用户可以读取
      allow read: if request.auth != null && (
        resource.data.requesterUid == request.auth.uid ||
        resource.data.targetUid == request.auth.uid
      );

      // 更新权限：仅 Cloud Function 可以更新（通过 Admin SDK）
      // 客户端无更新权限
      allow update: if false;

      // 删除权限：请求者可以删除自己发起的请求
      allow delete: if request.auth != null &&
                       resource.data.requesterUid == request.auth.uid;
    }

    // ====================================================================
    // 默认拒绝所有其他集合的访问
    // ====================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}